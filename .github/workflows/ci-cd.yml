name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # ==========================================================
  # CI/CD PIPELINE
  # Uses variables for directory and branch
  # ==========================================================
  pipeline:
    runs-on: self-hosted
    env:
      TARGET_DIR: /opt/laravel-paas
      BRANCH: main
    steps:
      # 1. Update Codebase (In Place)
      - name: Update Codebase
        run: |
          if [ ! -d "$TARGET_DIR" ]; then
            echo "âŒ Directory $TARGET_DIR does not exist!"
            exit 1
          fi
          cd "$TARGET_DIR"
          echo "ğŸ“‚ Working directory: $(pwd)"
          # Ensure git trusts this directory
          git config --global --add safe.directory "$TARGET_DIR"
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin "$BRANCH"

      # 2. Deployment / Restart
      - name: Restart Infrastructure
        run: |
          cd "$TARGET_DIR"
          echo "ğŸ”„ Restarting Services..."
          if [ -f "./scripts/start.sh" ]; then
            chmod +x ./scripts/start.sh
            ./scripts/start.sh
          else
            echo "âŒ scripts/start.sh not found!"
            exit 1
          fi
          echo "âœ… Deployment Successful!"

      # 3. Notifications
      - name: Notify Success
        if: success()
        run: |
          if [ -f "$TARGET_DIR/.env" ]; then
            set -a; source "$TARGET_DIR/.env"; set +a
          fi
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials missing, skipping."
            exit 0
          fi
          cd "$TARGET_DIR"
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s" | sed 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g')
          MSG="âœ… <b>Laravel PaaS Deploy SUKSES!</b>%0A%0A"
          MSG="${MSG}ğŸ“¦ <b>Branch:</b> <code>$BRANCH</code>%0A"
          MSG="${MSG}ğŸ”— <b>Commit:</b> <code>$COMMIT_HASH</code>%0A"
          MSG="${MSG}ğŸ“ <b>Log:</b> $LAST_COMMIT_MSG%0A%0A"
          MSG="${MSG}ğŸš€ Services restarted & live."
          set +x
          TELEGRAM_API="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
          IFS=',' read -ra CHAT_IDS <<< "$TELEGRAM_CHAT_ID"
          for CHAT_ID in "${CHAT_IDS[@]}"; do
            curl -s -X POST "$TELEGRAM_API" -d chat_id="$CHAT_ID" -d text="$MSG" -d parse_mode="HTML" > /dev/null 2>&1
          done

      - name: Notify Failure
        if: failure()
        run: |
          if [ -f "$TARGET_DIR/.env" ]; then
             set -a; source "$TARGET_DIR/.env"; set +a
          fi
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then exit 0; fi
          cd "$TARGET_DIR"
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          MSG="âŒ <b>Laravel PaaS Deploy GAGAL!</b>%0A%0A"
          MSG="${MSG}âš ï¸ Pipeline stopped at error.%0A"
          MSG="${MSG}ğŸ”— <b>Commit:</b> <code>$COMMIT_HASH</code>%0A"
          MSG="${MSG}ğŸ” Check GitHub Actions logs."
          set +x
          TELEGRAM_API="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
          IFS=',' read -ra CHAT_IDS <<< "$TELEGRAM_CHAT_ID"
          for CHAT_ID in "${CHAT_IDS[@]}"; do
            curl -s -X POST "$TELEGRAM_API" -d chat_id="$CHAT_ID" -d text="$MSG" -d parse_mode="HTML" > /dev/null 2>&1
          done
